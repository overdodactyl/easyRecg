---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# easyRecg

<!-- badges: start -->
<!-- badges: end -->

## Installation

You can install the development version of `easyRecg` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("rickeycarter/easyRecg")
```

```{r eval = FALSE}
library(easyRecg)
library(tibble)
```

```{r echo = FALSE, include = FALSE}
devtools::load_all(".")
library(tibble)
```


## Retrieving 12-lead data

A matrix with data for 12-leads can be generated using the function `read_muse_xml_ecg`:

```{r}
# Get sample file
file1 <- ecg_example("muse/muse_ecg1.xml")

# Read xml file - return a 2d matrix
ecg1_2d <- read_muse_xml_ecg(file1, numpyformat = F)

dim(ecg1_2d)

head(ecg1_2d)

# Instead, return a 4d array formatted for AI inputs
ecg1_4d <- read_muse_xml_ecg(file1, numpyformat = T)

dim(ecg1_4d)
```


A directory of ecg files can be read and returned as an array using the `read_muse_xml_directory` function:

```{r}
# Sample directory of muse files
muse_dir <- system.file("extdata", path = "muse", package = "easyRecg")

# Check number of files 
length(dir(muse_dir))

# Read xml files
all_muse <- read_muse_xml_directory(muse_dir)

names(all_muse)
dim(all_muse$ecg_array)
```

## Retrieving ECG Meta Data

By default, `read_muse_xml_meta` returns all meta data available.  The returned object is a named list of data frames (or tibbles). The function can take a file path or a collection of file paths.  If more than one file path is present, the results are appended together.

```{r}
meta1 <- read_muse_xml_meta(file1, ids = 1)
meta1
```

### Customizing Output Results 

In some cases, you may not want all data returned (e.g. to avoid sharing PHI).  To do so, you can take a whitelisting, blacklisting, or mixed approach.

#### Whitelisting

To include only certain data sets or columns, you can specify a named list of dataframes and columns.  If a named element is `NA`, all variables from that dataset are returned.

Here, we will return only muse data, patient id and age, and test date.

```{r}
include <- list(
  muse_info = NA,
  patient_demographics = c("patient_id", "patient_age", "age_units"),
  test_demographics = "acquisition_date"
)

read_muse_xml_meta(file1, include = include, id = 1)
```


#### Blacklisting

Similar to whitelisting, you can specifiy specific data sets or elements to exclude.  Here, if a named element is `NA`, the entire dataset is removed.

Let's remove all resting ecg data along with patient names:

```{r}
exclude <- list(
  resting_ecg_measurements = NA,
  original_resting_ecg_measurements = NA,
  patient_demographics = c("patient_last_name")
)

read_muse_xml_meta(file1, exclude = exclude, ids = 1)
```


#### Mixed filtering

If you want more flexibility but don't want to type out all names/variables, you can use both `include` and `exclude`.  The same logic above applies here, however the `include` is always executed first.

Here, we will return all patient demographics except name:


```{r}
# Only consider the patient demographics
include <- list(patient_demographics = NA)

# Remove patient name
exclude <- list(patient_demographics = c("patient_last_name"))

read_muse_xml_meta(file1, include = include, exclude = exclude, ids = 1)
```

## Data Sources

ECG XML files included in this package are simulated and do not represent actual patient evaluations. 
